<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Suppression Images</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0; 
        }
        .test-container { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 10px 0; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-btn { background: #007bff; color: white; }
        .danger-btn { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>🧪 Test de Suppression d'Images</h1>
    
    <div class="test-container">
        <h2>1. Configuration de test</h2>
        <button class="test-btn" onclick="setupAdmin()">🔧 Configurer mode Admin</button>
        <button class="test-btn" onclick="checkAPI()">🔌 Tester API Photos</button>
        <div id="setup-results"></div>
    </div>
    
    <div class="test-container">
        <h2>2. Test de la fonction de suppression</h2>
        <button class="test-btn" onclick="listPhotos()">📸 Lister les photos</button>
        <button class="danger-btn" onclick="testDeleteFunction()">🗑️ Tester suppression (simulation)</button>
        <div id="delete-results"></div>
    </div>
    
    <div class="test-container">
        <h2>3. Navigation</h2>
        <button class="test-btn" onclick="openPhotographiePage()">📄 Ouvrir photographie.html</button>
        <button class="test-btn" onclick="openConsole()">🔍 Instructions console</button>
    </div>

    <script>
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-container ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }
        
        function setupAdmin() {
            // Configurer le localStorage pour simuler un admin connecté
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('is_admin', 'true');
            localStorage.setItem('user_nom', 'Admin Test');
            localStorage.setItem('sessionToken', 'test-token-123');
            
            addResult('setup-results', '✅ Mode administrateur configuré dans localStorage', 'success');
            addResult('setup-results', '🔧 Vous êtes maintenant configuré comme admin pour les tests', 'info');
        }
        
        async function checkAPI() {
            try {
                const response = await fetch('/api/photos');
                if (response.ok) {
                    const data = await response.json();
                    addResult('setup-results', `✅ API accessible - ${data.photos?.length || 0} photos trouvées`, 'success');
                    
                    if (data.photos && data.photos.length > 0) {
                        const photoList = data.photos.slice(0, 3).map(p => `📄 ${p.filename} (ID: ${p.id})`).join('<br>');
                        addResult('setup-results', `📋 Exemples de photos:<br>${photoList}`, 'info');
                    }
                } else {
                    addResult('setup-results', `❌ API erreur: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult('setup-results', `❌ Erreur connexion API: ${error.message}`, 'error');
            }
        }
        
        async function listPhotos() {
            try {
                const response = await fetch('/api/photos');
                const data = await response.json();
                
                if (data.photos && data.photos.length > 0) {
                    const photoTable = data.photos.map(p => 
                        `<tr>
                            <td>${p.id}</td>
                            <td>${p.filename}</td>
                            <td>${p.title}</td>
                            <td><button class="danger-btn" onclick="deletePhotoTest(${p.id}, '${p.filename}')">🗑️ Supprimer</button></td>
                        </tr>`
                    ).join('');
                    
                    addResult('delete-results', `
                        <table border="1" style="width:100%; border-collapse: collapse;">
                            <tr style="background: #f8f9fa;">
                                <th>ID</th>
                                <th>Nom du fichier</th>
                                <th>Titre</th>
                                <th>Action</th>
                            </tr>
                            ${photoTable}
                        </table>
                    `, 'info');
                } else {
                    addResult('delete-results', '📂 Aucune photo trouvée dans la base', 'info');
                }
            } catch (error) {
                addResult('delete-results', `❌ Erreur: ${error.message}`, 'error');
            }
        }
        
        async function deletePhotoTest(photoId, filename) {
            if (!confirm(`🗑️ Supprimer définitivement "${filename}" (ID: ${photoId}) ?`)) {
                return;
            }
            
            try {
                const sessionToken = localStorage.getItem('sessionToken');
                const response = await fetch('/api/photos', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({ id: photoId, filename: filename })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addResult('delete-results', `✅ Photo "${filename}" supprimée avec succès !<br>📊 Lignes affectées: ${result.deletedRows}`, 'success');
                    
                    // Actualiser la liste
                    setTimeout(() => {
                        document.getElementById('delete-results').innerHTML = '';
                        listPhotos();
                    }, 1000);
                } else {
                    const errorData = await response.json();
                    addResult('delete-results', `❌ Erreur suppression: ${errorData.error}`, 'error');
                }
            } catch (error) {
                addResult('delete-results', `❌ Erreur connexion: ${error.message}`, 'error');
            }
        }
        
        function testDeleteFunction() {
            addResult('delete-results', `
                🧪 <strong>Test de la fonction deletePhoto():</strong><br>
                ✅ Fonction améliorée avec:<br>
                • Animation de suppression<br>
                • Feedback visuel (overlay "Suppression...")<br>
                • Confirmation avant suppression<br>
                • Suppression de la base ET du fichier physique<br>
                • Gestion d'erreurs améliorée<br>
                • Rechargement automatique de la galerie<br><br>
                🔧 <strong>Pour tester en conditions réelles:</strong><br>
                1. Ouvrez photographie.html<br>
                2. Activez le mode suppression (bouton 🗑️)<br>
                3. Cliquez sur une croix rouge ✕<br>
                4. Confirmez la suppression
            `, 'info');
        }
        
        function openPhotographiePage() {
            window.open('/photographie.html', '_blank');
            addResult('delete-results', '📄 Page photographie.html ouverte dans un nouvel onglet', 'info');
        }
        
        function openConsole() {
            addResult('delete-results', `
                🔍 <strong>Instructions pour tester dans la console (F12):</strong><br><br>
                <code>
                // 1. Vérifier le mode admin<br>
                console.log('Mode admin:', localStorage.getItem('is_admin'));<br><br>
                
                // 2. Lister les photos<br>
                fetch('/api/photos').then(r => r.json()).then(console.log);<br><br>
                
                // 3. Activer le mode suppression<br>
                toggleDeleteMode();<br><br>
                
                // 4. Tester la suppression d'une photo (remplacez les valeurs)<br>
                deletePhoto(1, 'nom-du-fichier.jpg');
                </code>
            `, 'info');
        }
        
        // Auto-test au chargement
        window.addEventListener('load', () => {
            addResult('setup-results', '🧪 Page de test chargée. Utilisez les boutons ci-dessus pour tester la suppression.', 'info');
        });
    </script>
</body>
</html>
